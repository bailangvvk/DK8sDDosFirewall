user root;
daemon off;
# worker_processes 4;
# worker_cpu_affinity 0001 0010 0100 1000;
worker_processes 1;
worker_cpu_affinity 1;
error_log /dev/stdout;
events {
    worker_connections 10240;
    use epoll;
}

http {
    log_format access '$remote_addr $server_port - $http_host [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      '$http_x_forwarded_for|$http_x_real_ip|$limit_key';
    # access_log /dev/stdout access;
    access_log off;

    geo $limit {
        default 1;
        192.168.0.0/24 0;
        10.0.0.0/8 0;
        127.0.0.0/8 0;
    }
    map $http_x_forwarded_for $real_ip {
        default         $remote_addr;
        "~^(?P<ip>[^,]+)" $ip;
    }
    map $limit $limit_key {
        0 "";
        1 $real_ip;
    }

    # limit_req_zone $limit_key   zone=req_ip:10m   rate=5r/s;
    # limit_req_zone $server_name zone=req_svr:1m   rate=1000r/s;
    # limit_req_zone $uri         zone=req_res:10m  rate=3r/s;
    # limit_req_status 444;
    # limit_conn_zone $limit_key zone=con_ip:10m;
    # limit_conn_status 444;
    lua_shared_dict traffic_stats 50m;
    lua_package_path "/app/?.ljbc;/app/?.lua;;";
    server {
        resolver 8.8.8.8 ipv6=off;
        listen 80;
        listen 443 ssl;
        autoindex off;
        root /app/public/;
        # ssl_stapling on;
        # ssl_stapling_verify on;
        ssl_certificate /app/cert.pem;
        ssl_certificate_key /app/cert.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_prefer_server_ciphers on;
        add_header Strict-Transport-Security "max-age=2592000";

        gzip on;
        gzip_types *;
        gzip_comp_level 6;
        gzip_min_length 256;
        gzip_buffers 16 8k;
        gzip_proxied any;
        gzip_vary on;
        gzip_disable "MSIE [1-6]\.(?!.*SV1)";

        server_name www.dk8s.com;

        # limit_rate 100k;
        # limit_rate_after 1m;
        # limit_conn con_ip 40;

        lua_check_client_abort on;
        include /app/env.conf;

        location / {
            # limit_req zone=req_ip burst=100 delay=200;
            # limit_req zone=req_svr burst=1000 delay=2000;
            # lua_code_cache off;
            # access_by_lua_file /app/protect.lua;
            # log_by_lua_file /app/record.lua;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            access_by_lua_file /app/protect.ljbc;
            log_by_lua_file /app/record.ljbc;
            proxy_pass http://127.0.0.1:3000;
        }

        location /dk8s.stats {
            # limit_req zone=req_ip burst=100 delay=200;
            # limit_req zone=req_svr burst=1000 delay=2000;
            # lua_code_cache off;
            # access_by_lua_file /app/protect.lua;
            # log_by_lua_file /app/record.lua;
            access_by_lua_file /app/protect.ljbc;
            content_by_lua_file /app/stats.ljbc;
            log_by_lua_file /app/record.ljbc;
        }

        location ~* \.(jpg|png|jpeg)$ {
            # limit_req zone=req_ip burst=100 delay=200;
            # limit_req zone=req_svr burst=1000 delay=2000;
            # limit_req zone=req_res burst=200 delay=1000;
            # lua_code_cache off;
            # access_by_lua_file /app/protect.lua;
            # log_by_lua_file /app/record.lua;
            expires 7d;
            proxy_set_header Host $host;
            access_by_lua_file /app/protect.ljbc;
            log_by_lua_file /app/record.ljbc;
            proxy_pass http://127.0.0.1:3000;
        }

        location ~* \.(js|css|svg|woff|woff2)$ {
            # limit_req zone=req_ip burst=100 delay=200;
            # limit_req zone=req_svr burst=1000 delay=2000;
            # limit_req zone=req_res burst=200 delay=1000;
            # lua_code_cache off;
            # access_by_lua_file /app/protect.lua;
            # log_by_lua_file /app/record.lua;
            expires 1d;
            proxy_set_header Host $host;
            add_header Cache-Control no-cache;
            access_by_lua_file /app/protect.ljbc;
            log_by_lua_file /app/record.ljbc;
            proxy_pass http://127.0.0.1:3000;
        }

        error_page 429 @429;
        location @429 {
            return 429 "error";
        }

        location /control_group {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://127.0.0.1:3000;
            access_by_lua_block {
                ngx.exit(429)
            }
            log_by_lua_block {
                local a=0;
            }
        }
    }

    server {
        listen 80 default_server;
        listen 443 ssl default_server;
        ssl_reject_handshake on;
        return 444;
    }

    server {
        listen 3000;
        location / {
            return 200 'Ok';
        }
    }
}
